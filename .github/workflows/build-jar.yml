name: Build JAR

on:
  pull_request:
    branches: [main, next]
    types: [opened, synchronize, reopened, ready_for_review]
  release:
    types: [published]
  push:
    branches: [next]
  workflow_dispatch:
    # Manual workflow_dispatch exists only to allow safe testing of publishing changes.
    # Normal publishing is driven by release-please PRs and GitHub Releases.
    inputs:
      build_type:
        description: "Override build type (pr/dev/snapshot/release)"
        required: true
        default: "dev"
        type: choice
        options:
          - pr
          - dev
          - snapshot
          - release
      publish:
        description: "Actually publish (otherwise build only)"
        required: true
        default: false
        type: boolean

permissions:
  contents: write  # needed for release uploads; harmless for PRs

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Determine Java version
        id: java_version
        shell: bash
        run: |
          # next branch requires Java 25 (unobfuscated MC 26.1+)
          # main branch requires Java 21 (MC 1.21.x)
          if [[ "${{ github.ref }}" == "refs/heads/next" ]] || [[ "${{ github.base_ref }}" == "next" ]]; then
            echo "version=25" >> "$GITHUB_OUTPUT"
          else
            echo "version=21" >> "$GITHUB_OUTPUT"
          fi
          echo "â˜• Java version: $(grep version= $GITHUB_OUTPUT | cut -d= -f2)"

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: ${{ steps.java_version.outputs.version }}

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Determine build type
        id: build_type
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TYPE="${{ inputs.build_type }}"
          elif [[ "${{ github.event_name }}" == "release" ]]; then
            TYPE="release"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/next" ]]; then
            TYPE="snapshot"
          elif [[ "${{ github.actor }}" == "release-please[bot]" || "${{ github.head_ref }}" == release-please--* ]]; then
            TYPE="dev"
          else
            TYPE="pr"
          fi

          echo "type=$TYPE" >> "$GITHUB_OUTPUT"
          echo "ðŸ”Ž Build type: $TYPE"

      - name: Compute version
        id: version
        shell: bash
        run: |
          SHA7="$(git rev-parse --short=7 HEAD)"
          TYPE="${{ steps.build_type.outputs.type }}"
          MC_VERSION="$(grep '^minecraft_version=' gradle.properties | cut -d'=' -f2)"

          case "$TYPE" in
            release)
              VERSION="${{ github.event.release.tag_name }}"
              VERSION="${VERSION#v}"
              BUILD_VERSION="$VERSION"
              ;;

            dev)
              NEXT_VERSION="$(cat version.txt)"
              BUILD_VERSION="${NEXT_VERSION}-dev.${SHA7}"
              ;;

            snapshot)
              NEXT_VERSION="$(cat version.txt)"
              BUILD_VERSION="${NEXT_VERSION}-snapshot.${SHA7}"
              ;;

            pr)
              BUILD_VERSION="pr${{ github.event.pull_request.number }}.${SHA7}"
              ;;

            *)
              echo "Unknown build type: $TYPE" >&2
              exit 1
              ;;
          esac

          echo "mod_version=$BUILD_VERSION" >> "$GITHUB_OUTPUT"
          echo "minecraft_version=$MC_VERSION" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ version: $BUILD_VERSION"
          echo "ðŸŽ® Minecraft: $MC_VERSION"

      - name: Build
        run: ./gradlew clean jar --no-daemon
        env:
          MOD_VERSION: ${{ steps.version.outputs.mod_version }}

      - name: Publish (dev)
        if: ${{ steps.build_type.outputs.type == 'dev' && (github.event_name != 'workflow_dispatch' || inputs.publish) }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          name: "Logistics: Automation v${{ steps.version.outputs.mod_version }}"
          version: ${{ steps.version.outputs.mod_version }}
          version-type: beta
          changelog: "Automated dev build from commit ${{ github.sha }}"

          files: |
            build/libs/!(*-@(dev|sources|javadoc)).jar

          modrinth-featured: false
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          fail-mode: warn
          retry-attempts: 2
          retry-delay: 10000

      - name: Publish (snapshot)
        if: ${{ steps.build_type.outputs.type == 'snapshot' && (github.event_name != 'workflow_dispatch' || inputs.publish) }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          name: "Logistics: Automation v${{ steps.version.outputs.mod_version }} (MC ${{ steps.version.outputs.minecraft_version }})"
          version: ${{ steps.version.outputs.mod_version }}
          version-type: alpha
          changelog: "Automated snapshot build for Minecraft ${{ steps.version.outputs.minecraft_version }} from commit ${{ github.sha }}"

          files: |
            build/libs/!(*-@(dev|sources|javadoc)).jar

          modrinth-featured: false
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          fail-mode: warn
          retry-attempts: 2
          retry-delay: 10000

      - name: Publish (release)
        if: ${{ steps.build_type.outputs.type == 'release' && (github.event_name != 'workflow_dispatch' || inputs.publish) }}
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          name: "Logistics: Automation v${{ steps.version.outputs.mod_version }}"
          version: ${{ github.event_name == 'release' && github.event.release.tag_name || steps.version.outputs.mod_version }}
          version-type: release
          changelog: ${{ github.event_name == 'release' && github.event.release.body || format('Manual {0} publish from {1}', steps.build_type.outputs.type, github.sha) }}

          files: |
            build/libs/!(*-@(dev|sources|javadoc)).jar

          modrinth-featured: true
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
