name: Build (PR)

on:
  pull_request:
    branches: [main, 'mc/**']
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'src/**'
      - 'gradle.properties'
      - 'build.gradle'
      - 'settings.gradle'
      - 'gradle/**'

jobs:
  build:
    # Skip: draft PRs, release-please PRs
    if: |
      github.event.pull_request.draft == false &&
      !startsWith(github.head_ref, 'release-please--')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '25'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: Compute version
        id: version
        run: |
          MC_VERSION="$(grep '^minecraft_version=' gradle.properties | cut -d'=' -f2)"
          MC_VERSION_CLEAN="$(echo "$MC_VERSION" | sed 's/-snapshot-[0-9]\+$//')"
          SHA7="$(git rev-parse --short=7 HEAD)"
          PR_NUM="${{ github.event.pull_request.number }}"
          TARGET_BRANCH="${{ github.base_ref }}"

          # Example: dev-pr.123+mc26.1.sha.a1b2c3d
          BUILD_VERSION="dev-pr.${PR_NUM}+mc${MC_VERSION}.sha.${SHA7}"

          # Determine Gradle task based on target branch
          # main branch uses 'jar' (MC 26.1+ is not obfuscated)
          # mc/** branches use 'remapJar' (MC 1.21.11 and earlier are obfuscated)
          if [[ "$TARGET_BRANCH" == "main" ]]; then
            GRADLE_TASK="jar"
          else
            GRADLE_TASK="remapJar"
          fi

          echo "mod_version=$BUILD_VERSION" >> "$GITHUB_OUTPUT"
          echo "minecraft_version_clean=$MC_VERSION_CLEAN" >> "$GITHUB_OUTPUT"
          echo "gradle_task=$GRADLE_TASK" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Version: $BUILD_VERSION"
          echo "ðŸ”¨ Gradle task: $GRADLE_TASK (target: $TARGET_BRANCH)"

      - name: Build
        run: ./gradlew ${{ steps.version.outputs.gradle_task }} --console=plain
        env:
          MOD_VERSION: ${{ steps.version.outputs.mod_version }}

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: logistics-pr-${{ github.event.pull_request.number }}-${{ github.run_id }}
          path: build/libs/logistics-*.jar
