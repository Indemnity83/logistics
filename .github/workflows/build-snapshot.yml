name: Build (Snapshot)

on:
  push:
    branches: [next]
  workflow_dispatch:
    inputs:
      publish:
        description: "Actually publish (otherwise build only)"
        required: true
        default: false
        type: boolean

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '25'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-encryption-key: ${{ secrets.GRADLE_ENCRYPTION_KEY }}

      - name: Compute version
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          MC_VERSION="$(grep '^minecraft_version=' gradle.properties | cut -d'=' -f2)"

          # Use GitHub run number for snapshot builds (monotonic, survives rebases/force-pushes)
          BUILD_NO="${GITHUB_RUN_NUMBER}"

          # Try to get the next version from an open release-please PR targeting next.
          # Falls back to version.txt if no PR is found.
          get_release_please_version() {
            local base_branch="$1"

            if [[ -z "${GITHUB_TOKEN:-}" ]]; then
              return 1
            fi

            local pr_head_ref
            pr_head_ref="$(curl -fsSL \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls?state=open&base=${base_branch}&per_page=100" \
              | jq -r 'map(select(.head.ref | startswith("release-please--")))
                       | sort_by(.updated_at)
                       | last
                       | .head.ref // empty')"

            if [[ -z "$pr_head_ref" || "$pr_head_ref" == "null" ]]; then
              return 1
            fi

            git fetch --no-tags --depth=1 origin "+refs/heads/${pr_head_ref}:refs/remotes/origin/${pr_head_ref}" >/dev/null 2>&1 || return 1
            git show "origin/${pr_head_ref}:version.txt" 2>/dev/null || return 1
          }

          NEXT_VERSION="$(get_release_please_version main || cat version.txt)"

          # Version for display (short): 0.3.1-snapshot-1234
          # Version for filename (full): 0.3.1-snapshot-1234+mc.26.1-snapshot-4
          MOD_VERSION="${NEXT_VERSION}-snapshot-${BUILD_NO}"
          FILE_VERSION="${MOD_VERSION}+mc.${MC_VERSION}"

          echo "mod_version=$MOD_VERSION" >> "$GITHUB_OUTPUT"
          echo "file_version=$FILE_VERSION" >> "$GITHUB_OUTPUT"
          echo "minecraft_version=$MC_VERSION" >> "$GITHUB_OUTPUT"
          echo "next_version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
          echo "build_no=$BUILD_NO" >> "$GITHUB_OUTPUT"
          echo "ðŸ“¦ Version: $MOD_VERSION (file: $FILE_VERSION)"

      - name: Build
        run: ./gradlew jar --console=plain
        env:
          MOD_VERSION: ${{ steps.version.outputs.file_version }}

      - name: Publish
        if: github.event_name != 'workflow_dispatch' || inputs.publish
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          name: "Logistics: Automation v${{ steps.version.outputs.next_version }}-snapshot (build ${{ steps.version.outputs.build_no }})"
          version: ${{ steps.version.outputs.mod_version }}
          version-type: alpha
          changelog: "Automated snapshot build for Minecraft ${{ steps.version.outputs.minecraft_version }} from commit ${{ github.sha }}"
          game-versions: ${{ steps.version.outputs.minecraft_version }}
          game-version-filter: any

          files: |
            build/libs/!(*-@(dev|sources|javadoc)).jar

          modrinth-featured: false
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          fail-mode: warn
          retry-attempts: 2
          retry-delay: 10000